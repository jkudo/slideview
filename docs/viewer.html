<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Modern PDF Viewer</title>
  
  <!-- Bootstrap 5 CSS (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />

  <!-- PDF.js (CDN) -->
  <!-- バージョンは https://cdnjs.com/libraries/pdf.js などで適宜更新してください -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <style>
    body {
      background-color: #f8f9fa;
    }
    #sidebar {
      min-height: 100vh;
      border-right: 1px solid #ddd;
    }
    #pdf-list .list-group-item {
      cursor: pointer;
    }
    #pdfCanvas {
      border: 1px solid #ccc;
      max-width: 100%;
    }
  </style>
</head>

<body>
<div class="container-fluid">
  <div class="row">
    <!-- ===================== 左サイドバー ===================== -->
    <div class="col-3 bg-white" id="sidebar">
      <h4 class="p-3 border-bottom">Slides</h4>
      <ul class="list-group list-group-flush" id="pdf-list">
        <!-- この中にPDFファイルのリストを動的に追加します -->
      </ul>
    </div>

    <!-- ===================== 右メインビュー ===================== -->
    <div class="col-9 p-4">
      <h1 class="mb-4">PDF.js Page Viewer</h1>

      <!-- キャンバス: 1ページ分を描画 -->
      <canvas id="pdfCanvas"></canvas>

      <!-- ページめくりボタン & ページ情報 -->
      <div class="mt-4">
        <button class="btn btn-primary me-2" onclick="prevPage()">Prev</button>
        <button class="btn btn-primary me-2" onclick="nextPage()">Next</button>
        <span id="pageInfo" class="fw-bold"></span>
      </div>
    </div>
  </div>
</div>

<!-- ===================== JavaScript ===================== -->
<script>
  // ----------------------------------------------------------------
  // 1) PDF.js の準備
  // ----------------------------------------------------------------
  const pdfjsLib = window['pdfjs-dist/build/pdf'];
  pdfjsLib.GlobalWorkerOptions.workerSrc = 
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

  // PDF表示関連の変数
  let pdfDoc = null;          // 現在ロード中のPDFドキュメント
  let pageNum = 1;            // 現在のページ番号
  let pageRendering = false;  // ページ描画中フラグ
  let pageNumPending = null;  // 描画待ちフラグ
  const scale = 1.0;          // 拡大率
  const canvas = document.getElementById('pdfCanvas');
  const ctx = canvas.getContext('2d');
  const pageInfo = document.getElementById('pageInfo');

  // ----------------------------------------------------------------
  // 2) 読み込むPDFを切り替える関数
  // ----------------------------------------------------------------
  function loadPdf(pdfFileName) {
    const pdfUrl = "./pdfs/" + pdfFileName;
    pageNum = 1;           // 常に最初のページから
    pageRendering = false;
    pageNumPending = null;

    pdfjsLib.getDocument(pdfUrl).promise.then(doc => {
      pdfDoc = doc;
      console.log("PDF loaded:", pdfFileName, "Pages:", doc.numPages);
      renderPage(pageNum);
    }).catch(err => {
      alert("Could not load PDF: " + err.message);
    });
  }

  // ----------------------------------------------------------------
  // 3) 指定ページを描画する関数
  // ----------------------------------------------------------------
  function renderPage(num) {
    pageRendering = true;
    pageInfo.textContent = `Loading page ${num}...`;

    pdfDoc.getPage(num).then(page => {
      const viewport = page.getViewport({ scale: scale });
      canvas.width = viewport.width;
      canvas.height = viewport.height;

      const renderContext = {
        canvasContext: ctx,
        viewport: viewport
      };
      const renderTask = page.render(renderContext);
      return renderTask.promise;
    }).then(() => {
      pageRendering = false;
      pageInfo.textContent = `Page ${num} / ${pdfDoc.numPages}`;
      // 待機中のページ切り替えがあれば実行
      if (pageNumPending !== null) {
        renderPage(pageNumPending);
        pageNumPending = null;
      }
    });
  }

  // ページ切り替え時に描画中なら待機させる
  function queueRenderPage(num) {
    if (pageRendering) {
      pageNumPending = num;
    } else {
      renderPage(num);
    }
  }

  // ----------------------------------------------------------------
  // 4) Prev / Next ボタン
  // ----------------------------------------------------------------
  function prevPage() {
    if (!pdfDoc) return;
    if (pageNum <= 1) return;
    pageNum--;
    queueRenderPage(pageNum);
  }

  function nextPage() {
    if (!pdfDoc) return;
    if (pageNum >= pdfDoc.numPages) return;
    pageNum++;
    queueRenderPage(pageNum);
  }

  // ----------------------------------------------------------------
  // 5) 左サイドバーのPDF一覧を生成
  // ----------------------------------------------------------------
  // 実際には generate-index.js などでリストを取得する方法があるかもしれませんが、
  // ここではサンプルとして "pdfs/" ディレクトリにあるPDF名をハードコーディング
  // もしくは別の方法で自動生成することを推奨します。
  const pdfFiles = [
    "sample1.pdf",
    "sample2.pdf"
    // ここに追加していけばOK
  ];

  const pdfListEl = document.getElementById('pdf-list');

  pdfFiles.forEach(fileName => {
    const li = document.createElement('li');
    li.className = "list-group-item";
    li.textContent = fileName;
    li.onclick = () => loadPdf(fileName);
    pdfListEl.appendChild(li);
  });

  // デモとして、ページロード時に一つ目のPDFを読み込む
  if (pdfFiles.length > 0) {
    loadPdf(pdfFiles[0]);
  }
</script>

<!-- Bootstrap 5 JS (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
