<!-- docs/viewer.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Modern PDF Viewer</title>
  
  <!-- Bootstrap 5 CSS (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />

  <!-- PDF.js (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <style>
    body {
      background-color: #f8f9fa;
    }
    #sidebar {
      min-height: 100vh;
      border-right: 1px solid #ddd;
    }
    #pdf-list .list-group-item {
      cursor: pointer;
    }
    #pdfCanvas {
      border: 1px solid #ccc;
      max-width: 100%;
    }
  </style>
</head>

<body>
<div class="container-fluid">
  <div class="row">
    <!-- 左サイドバー -->
    <div class="col-3 bg-white" id="sidebar">
      <h4 class="p-3 border-bottom">Slides (PDF List)</h4>
      <ul class="list-group list-group-flush" id="pdf-list">
        <!-- generate-index.js で作った pdf-list.json を fetch し、JSでここに追加 -->
      </ul>
    </div>

    <!-- 右メインビュー -->
    <div class="col-9 p-4">
      <h1 class="mb-4">PDF.js Page Viewer</h1>

      <!-- キャンバス：1ページ分を描画 -->
      <canvas id="pdfCanvas"></canvas>

      <!-- ページめくりボタン & ページ情報 -->
      <div class="mt-4">
        <button class="btn btn-primary me-2" onclick="prevPage()">Prev</button>
        <button class="btn btn-primary me-2" onclick="nextPage()">Next</button>
        <span id="pageInfo" class="fw-bold"></span>
      </div>
    </div>
  </div>
</div>

<script>
  // ==========================
  // PDF.js 初期設定
  // ==========================
  const pdfjsLib = window['pdfjs-dist/build/pdf'];
  pdfjsLib.GlobalWorkerOptions.workerSrc = 
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

  let pdfDoc = null;      // 現在ロード中のPDF
  let pageNum = 1;        // 現在のページ番号
  let pageRendering = false;
  let pageNumPending = null;
  const scale = 1.0;
  const canvas = document.getElementById('pdfCanvas');
  const ctx = canvas.getContext('2d');
  const pageInfo = document.getElementById('pageInfo');

  // ==========================
  // PDFを読み込んで1ページずつ描画
  // ==========================
  function loadPdf(pdfFileName) {
    const pdfUrl = "./pdfs/" + pdfFileName;
    pageNum = 1;
    pageRendering = false;
    pageNumPending = null;

    pdfjsLib.getDocument(pdfUrl).promise.then(doc => {
      pdfDoc = doc;
      console.log("PDF loaded:", pdfFileName, "Pages:", doc.numPages);
      renderPage(pageNum);
    }).catch(err => {
      alert("Could not load PDF: " + err.message);
    });
  }

  function renderPage(num) {
    pageRendering = true;
    pageInfo.textContent = `Loading page ${num}...`;

    pdfDoc.getPage(num).then(page => {
      const viewport = page.getViewport({ scale });
      canvas.width = viewport.width;
      canvas.height = viewport.height;

      const renderContext = {
        canvasContext: ctx,
        viewport: viewport
      };
      const renderTask = page.render(renderContext);
      return renderTask.promise;
    }).then(() => {
      pageRendering = false;
      pageInfo.textContent = `Page ${num} / ${pdfDoc.numPages}`;

      if (pageNumPending !== null) {
        renderPage(pageNumPending);
        pageNumPending = null;
      }
    });
  }

  function queueRenderPage(num) {
    if (pageRendering) {
      pageNumPending = num;
    } else {
      renderPage(num);
    }
  }

  function prevPage() {
    if (!pdfDoc) return;
    if (pageNum <= 1) return;
    pageNum--;
    queueRenderPage(pageNum);
  }

  function nextPage() {
    if (!pdfDoc) return;
    if (pageNum >= pdfDoc.numPages) return;
    pageNum++;
    queueRenderPage(pageNum);
  }

  // ==========================
  // pdf-list.json を fetch し、左サイドバーに一覧表示
  // ==========================
  fetch('./pdf-list.json')
    .then(res => {
      if (!res.ok) throw new Error('Failed to fetch pdf-list.json');
      return res.json();
    })
    .then(pdfFiles => {
      const pdfListEl = document.getElementById('pdf-list');
      // pdfFiles は ["sample1.pdf","sample2.pdf", ...] のような配列

      // 一覧を追加
      pdfFiles.forEach((fileName, idx) => {
        const li = document.createElement('li');
        li.className = "list-group-item";
        li.textContent = fileName;
        li.onclick = () => loadPdf(fileName);
        pdfListEl.appendChild(li);

        // 最初のPDFを自動ロード (例: pdfFiles[0]) したければこんな処理
        if (idx === 0) {
          loadPdf(fileName);
        }
      });
    })
    .catch(err => {
      console.error(err);
      alert("Failed to load pdf-list.json: " + err.message);
    });
</script>

<!-- Bootstrap 5 JS (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
